name: "Apply and push doc-sync patch"
description: "Apply the generated documentation diff, commit, push, and comment on the PR."
inputs:
  github-token:
    description: "GitHub token with repo scope"
    required: true
  doc_patch_file:
    description: "Path to the binary diff generated by doc-sync"
    required: true
  doc_report_path:
    description: "Path to the Markdown report"
    required: true
  doc_files_path:
    description: "Path to the file list"
    required: true
  head_ref:
    description: "Head branch reference"
    required: true
  pr_number:
    description: "Pull request number"
    required: true
outputs:
  commit_sha:
    description: "SHA of the doc-sync commit"
    value: ${{ steps.commit.outputs.sha }}
runs:
  using: "composite"
  steps:
    - name: Apply doc diff
      shell: bash
      env:
        DOC_PATCH_FILE: ${{ inputs.doc_patch_file }}
      run: git apply --index "$DOC_PATCH_FILE"

    - name: Commit and push documentation updates
      id: commit
      shell: bash
      env:
        HEAD_REF: ${{ inputs.head_ref }}
        PR_NUMBER: ${{ inputs.pr_number }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git commit -m "[skip ci][doc-sync] Auto-update docs for PR #$PR_NUMBER"
        git push origin HEAD:$HEAD_REF
        echo "sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

    - name: Comment on pull request
      uses: actions/github-script@v7
      env:
        REPORT_FILE: ${{ inputs.doc_report_path }}
        FILE_LIST: ${{ inputs.doc_files_path }}
        COMMIT_SHA: ${{ steps.commit.outputs.sha }}
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const fs = require('fs');
          const report = fs.readFileSync(process.env.REPORT_FILE, 'utf8').trim();
          const files = fs.existsSync(process.env.FILE_LIST)
            ? fs.readFileSync(process.env.FILE_LIST, 'utf8').split(/\r?\n/).filter(Boolean)
            : [];
          const body = [
            'ðŸ¤– Documentation synchronized automatically.',
            '',
            report,
            '',
            'Updated files:',
            files.length ? files.map((f) => `- ${f}`).join('\n') : '- (none)',
            '',
            `Commit: ${process.env.COMMIT_SHA}`
          ].join('\n');
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ inputs.pr_number }},
            body,
          });
