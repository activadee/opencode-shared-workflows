name: Go Tests

on:
  workflow_call:
    description: Reusable workflow that runs go test across the repository.
    inputs:
      go_version:
        description: Go version to install (ignored if go_version_file is set).
        required: false
        type: string
        default: ""
      go_version_file:
        description: Path to go.mod or .tool-versions file containing the Go version.
        required: false
        type: string
        default: go.mod
      working_directory:
        description: Directory to run tests from. Defaults to repository root.
        required: false
        type: string
        default: .
      test_flags:
        description: Extra flags passed to go test (e.g. ./... -run TestFoo -count=1).
        required: false
        type: string
        default: ./...
      enable_cache:
        description: Whether to enable setup-go cache integration.
        required: false
        type: boolean
        default: true
      pre_test:
        description: Optional shell script to run before go test.
        required: false
        type: string
        default: ""
    secrets: {}

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}
          go-version-file: ${{ inputs.go_version_file }}
          cache: ${{ inputs.enable_cache }}

      - name: Pre-test setup
        if: inputs.pre_test != ''
        working-directory: ${{ inputs.working_directory }}
        run: ${{ inputs.pre_test }}

      - name: Run go test
        working-directory: ${{ inputs.working_directory }}
        run: go test ${{ inputs.test_flags }}
