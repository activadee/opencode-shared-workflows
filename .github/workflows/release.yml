name: Codex Release

on:
  workflow_call:
    description: Reusable workflow to generate Codex-powered release notes and publish a GitHub release.
    inputs:
      tag_name:
        description: Tag to create or update (e.g. v0.1.0).
        required: true
        type: string
      release_title:
        description: Optional display name for the release (defaults to tag).
        required: false
        type: string
        default: ""
      target:
        description: Commit or branch to release.
        required: false
        type: string
        default: main
      draft:
        description: Create the release in draft mode.
        required: false
        type: boolean
        default: false
      codex_action_ref:
        description: Ref for activadee/codex-action (branch, tag, or SHA).
        required: false
        type: string
        default: main
      go_version:
        description: Go version to install (ignored if go_version_file provided).
        required: false
        type: string
        default: ""
      go_version_file:
        description: Path to file containing Go version (e.g. go.mod).
        required: false
        type: string
        default: go.mod
      run_tests:
        description: Whether to run go test before releasing.
        required: false
        type: boolean
        default: true
      test_flags:
        description: Additional flags passed to go test.
        required: false
        type: string
        default: ./...
    outputs:
      release_notes:
        description: Rendered release notes content.
        value: ${{ jobs.release.outputs.release_notes }}
    secrets:
      CODEX_AUTH_JSON_B64:
        description: Base64 encoded auth.json for Codex CLI.
        required: true

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.render.outputs.notes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ inputs.target }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}
          go-version-file: ${{ inputs.go_version_file }}
          cache: true

      - name: Run tests
        if: inputs.run_tests
        run: go test ${{ inputs.test_flags }}

      - name: Checkout shared workflow assets
        uses: actions/checkout@v5
        with:
          repository: ${{ github.workflow_ref.split('/.github/')[0] }}
          ref: ${{ github.workflow_ref.split('@')[1] }}
          path: __codex_shared

      - name: Determine previous tag
        id: prev_tag
        run: |
          git fetch --tags --quiet
          LAST_TAG=$(git describe --tags --abbrev=0 --match "v*" 2>/dev/null || echo "")
          echo "value=$LAST_TAG" >> "$GITHUB_OUTPUT"

      - name: Build Codex prompt
        id: prompt
        run: |
          TAG_NAME="${{ inputs.tag_name }}"
          LAST_TAG="${{ steps.prev_tag.outputs.value }}"

          if [ -z "$LAST_TAG" ]; then
            RANGE_DESC="project start"
            COMMITS=$(git log --pretty=format:'- %s (%h)' --no-merges)
          else
            RANGE_DESC="${LAST_TAG}..${GITHUB_SHA}"
            COMMITS=$(git log --pretty=format:'- %s (%h)' --no-merges "${LAST_TAG}..${GITHUB_SHA}")
          fi

          if [ -z "$COMMITS" ]; then
            COMMITS="- No new commits detected."
          fi

          TEMPLATE=$(cat __codex_shared/.github/prompts/codex-release-template.md)

          cat <<EOF > codex_prompt.md
          ${TEMPLATE}

          Release tag: ${TAG_NAME}
          Commit range: ${RANGE_DESC}

          Commits:
          ${COMMITS}
          EOF

      - name: Load release schema
        run: echo "CODEX_OUTPUT_SCHEMA=$(jq -c . __codex_shared/.github/prompts/codex-release-schema.json)" >> "$GITHUB_ENV"

      - name: Generate release highlights with Codex
        uses: activadee/codex-action@${{ inputs.codex_action_ref }}
        with:
          codex-auth-json-b64: ${{ secrets.CODEX_AUTH_JSON_B64 }}
          prompt-file: codex_prompt.md
          output-file: codex-release.json
          output-schema: ${{ env.CODEX_OUTPUT_SCHEMA }}
          safety-strategy: drop-sudo

      - name: Render release notes
        id: render
        run: |
          SUMMARY=$(jq -r '.overview // empty' codex-release.json)
          {
            if [ -n "$SUMMARY" ]; then
              echo "$SUMMARY"
              echo
            fi
            jq -r '.highlights[] | "- " + .' codex-release.json
          } > release-notes.md
          {
            echo "notes<<EOF"
            cat release-notes.md
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.tag_name }}
          target_commitish: ${{ inputs.target }}
          name: ${{ inputs.release_title || inputs.tag_name }}
          draft: ${{ inputs.draft }}
          body_path: release-notes.md
