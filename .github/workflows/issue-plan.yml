name: Codex Issue Implementation Plan

on:
  workflow_call:
    inputs:
      target_ref:
        description: Branch or ref that Codex should inspect (defaults to main).
        required: false
        type: string
        default: main
      issue_number:
        description: Optional issue number override when the triggering event is not an issue.
        required: false
        type: string
        default: ""
      prompt_extra:
        description: Additional markdown appended to the shared prompt.
        required: false
        type: string
        default: ""
      model:
        description: Codex model override.
        required: false
        type: string
        default: gpt-5.1-codex
      effort:
        description: Codex reasoning effort.
        required: false
        type: string
        default: high
      safety_strategy:
        description: Codex sandbox mode to use when invoking the Codex action.
        required: false
        type: string
        default: drop-sudo
      codex_args:
        description: Additional CLI arguments forwarded to Codex.
        required: false
        type: string
        default: '["--config","sandbox_workspace_write.network_access=true"]'
      pass_through_env:
        description: Comma-separated env vars forwarded to the Codex subprocess.
        required: false
        type: string
        default: GH_TOKEN,GITHUB_TOKEN
      max_issue_body_chars:
        description: Maximum characters from the issue body to include in the prompt.
        required: false
        type: number
        default: 8000
      max_comment_body_chars:
        description: Maximum characters per embedded issue comment.
        required: false
        type: number
        default: 2000
      max_comments:
        description: Number of most recent comments to include.
        required: false
        type: number
        default: 6
    secrets:
      CODEX_AUTH_JSON_B64:
        description: Base64 encoded auth.json for Codex CLI.
        required: true

permissions:
  contents: read
  issues: write

concurrency:
  group: issue-plan-${{ github.event.issue.number || inputs.issue_number || github.run_id }}
  cancel-in-progress: false

jobs:
  plan:
    name: Draft implementation plan with Codex
    runs-on: ubuntu-latest
    outputs:
      summary: ${{ steps.format.outputs.summary }}
      plan_markdown: ${{ steps.format.outputs.plan_markdown }}
      comment_url: ${{ steps.comment.outputs.comment_url }}
    steps:
      - name: Checkout repository
        uses: activadee/codex-shared-workflows/actions/common/checkout-target@main
        with:
          ref: ${{ inputs.target_ref }}
          fetch-depth: 0

      - name: Prepare Codex prompt
        id: prepare
        uses: activadee/codex-shared-workflows/actions/issue-plan/prepare@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ inputs.issue_number }}
          prompt-extra: ${{ inputs.prompt_extra }}
          default-branch: ${{ inputs.target_ref }}
          max-issue-body-chars: ${{ inputs.max_issue_body_chars }}
          max-comment-body-chars: ${{ inputs.max_comment_body_chars }}
          max-comments: ${{ inputs.max_comments }}

      - name: Run Codex issue planner
        id: run_codex
        uses: activadee/codex-action@main
        with:
          codex-auth-json-b64: ${{ secrets.CODEX_AUTH_JSON_B64 }}
          prompt-file: ${{ steps.prepare.outputs.prompt_path }}
          output-file: codex-output.json
          output-schema: ${{ steps.prepare.outputs.output_schema }}
          safety-strategy: ${{ inputs.safety_strategy }}
          codex-args: ${{ inputs.codex_args }}
          model: ${{ inputs.model }}
          effort: ${{ inputs.effort }}
          pass-through-env: ${{ inputs.pass_through_env }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build issue comment payload
        id: format
        uses: activadee/codex-shared-workflows/actions/issue-plan/format-comment@main
        with:
          output-path: codex-output.json
          issue-number: ${{ steps.prepare.outputs.issue_number }}
          issue-url: ${{ steps.prepare.outputs.issue_url }}
          issue-title: ${{ steps.prepare.outputs.issue_title }}

      - name: Comment on issue with gh
        id: comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ steps.prepare.outputs.issue_number }}
        run: |
          set -euo pipefail
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "::error::Unable to determine issue number" >&2
            exit 1
          fi
          body_file="${{ steps.format.outputs.comment_payload_path }}"
          if [ ! -f "$body_file" ]; then
            echo "::error::Missing comment payload at $body_file" >&2
            exit 1
          fi
          comment_url=$(gh api repos/${GITHUB_REPOSITORY}/issues/$ISSUE_NUMBER/comments \
            --method POST \
            --input "$body_file" \
            --jq '.html_url')
          echo "comment_url=$comment_url" >> "$GITHUB_OUTPUT"
