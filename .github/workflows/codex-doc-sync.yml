name: Codex Doc Sync

on:
  workflow_call:
    inputs:
      doc_globs:
        description: |-
          Newline-separated glob patterns that define documentation files (e.g., docs/**, **/*.md, README*).
        required: false
        type: string
        default: |
          docs/**
          **/*.md
          README*
      safety_strategy:
        description: Safety strategy passed to Codex (drop-sudo/read-only/unprivileged-user/unsafe).
        required: false
        type: string
        default: drop-sudo
      model:
        description: Optional Codex model override.
        required: false
        type: string
        default: ""
      effort:
        description: Optional Codex reasoning effort override.
        required: false
        type: string
        default: ""
      codex_args:
        description: Additional arguments passed to codex exec (JSON array or shell string).
        required: false
        type: string
        default: ""
    secrets:
      CODEX_AUTH_JSON_B64:
        description: Base64 encoded auth.json for Codex CLI.
        required: true

permissions:
  contents: write
  pull-requests: write

env:
  DOC_REPORT_PATH: doc-sync-report.md
  DOC_COMMITS_PATH: doc-commits.md
  DOC_GLOBS_FILE: doc-globs.txt
  DOC_PATCH_FILE: doc-changes.patch

jobs:
  prepare_inputs:
    runs-on: ubuntu-latest
    env:
      DOC_INPUTS_ARTIFACT: doc-sync-inputs-${{ github.run_id }}
    outputs:
      proceed: ${{ steps.context.outputs.proceed }}
      reason: ${{ steps.context.outputs.proceed_reason }}
      base_ref: ${{ steps.context.outputs.base_ref }}
      head_ref: ${{ steps.context.outputs.head_ref }}
      head_sha: ${{ steps.context.outputs.head_sha }}
      pr_number: ${{ steps.context.outputs.number }}
      repository: ${{ steps.context.outputs.repository }}
      inputs_artifact: ${{ env.DOC_INPUTS_ARTIFACT }}
    steps:
      - name: Resolve pull request context
        id: context
        uses: ./__codex_shared/actions/doc-sync/context
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Abort when doc sync is skipped
        if: steps.context.outputs.proceed != 'true'
        run: | 
            echo "Doc sync skipped: ${{ steps.context.outputs.proceed_reason }}"

      - name: Checkout target repository
        if: steps.context.outputs.proceed == 'true'
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ steps.context.outputs.head_sha }}


      - name: Prepare workspace
        if: steps.context.outputs.proceed == 'true'
        uses: ./__codex_shared/actions/doc-sync/prepare
        with:
          base_ref: ${{ steps.context.outputs.base_ref }}
          head_sha: ${{ steps.context.outputs.head_sha }}
          doc_report_path: ${{ env.DOC_REPORT_PATH }}
          doc_commits_path: ${{ env.DOC_COMMITS_PATH }}
          doc_globs_file: ${{ env.DOC_GLOBS_FILE }}
          doc_globs: ${{ inputs.doc_globs }}

      - name: Build Codex prompt
        if: steps.context.outputs.proceed == 'true'
        uses: ./__codex_shared/actions/doc-sync/build-prompt
        with:
          base_ref: ${{ steps.context.outputs.base_ref }}
          head_ref: ${{ steps.context.outputs.head_ref }}
          pr_number: ${{ steps.context.outputs.number }}
          repository: ${{ steps.context.outputs.repository }}
          report_path: ${{ env.DOC_REPORT_PATH }}
          template_path: __codex_shared/prompts/codex-doc-sync.md
          doc_globs_path: ${{ env.DOC_GLOBS_FILE }}
          prompt_path: codex_prompt.md
          commits_path: ${{ env.DOC_COMMITS_PATH }}

      - name: Upload doc-sync inputs
        if: steps.context.outputs.proceed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DOC_INPUTS_ARTIFACT }}
          retention-days: 7
          path: |
            codex_prompt.md
            ${{ env.DOC_GLOBS_FILE }}
            ${{ env.DOC_COMMITS_PATH }}

  edit_docs:
    needs: prepare_inputs
    if: needs.prepare_inputs.outputs.proceed == 'true'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      DOC_REPORT_ARTIFACT: doc-sync-report-${{ github.run_id }}
      DOC_PATCH_ARTIFACT: doc-sync-patch-${{ github.run_id }}
      DOC_FILES_ARTIFACT: doc-sync-files-${{ github.run_id }}
    outputs:
      changed: ${{ steps.edit.outputs.changed }}
      head_ref: ${{ needs.prepare_inputs.outputs.head_ref }}
      base_ref: ${{ needs.prepare_inputs.outputs.base_ref }}
      head_sha: ${{ needs.prepare_inputs.outputs.head_sha }}
      pr_number: ${{ needs.prepare_inputs.outputs.pr_number }}
      repository: ${{ needs.prepare_inputs.outputs.repository }}
      doc_report_artifact: ${{ env.DOC_REPORT_ARTIFACT }}
      doc_patch_artifact: ${{ env.DOC_PATCH_ARTIFACT }}
      doc_files_artifact: ${{ env.DOC_FILES_ARTIFACT }}
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare_inputs.outputs.head_sha }}

      - name: Checkout shared workflow assets
        uses: actions/checkout@v5
        with:
          repository: activadee/codex-shared-workflows
          ref: ${{ github.action_ref || 'main' }}
          path: __codex_shared

      - name: Restore doc-sync inputs
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.prepare_inputs.outputs.inputs_artifact }}
          path: doc-sync-inputs

      - name: Ignore helper artifacts
        run: |
          mkdir -p .git/info
          cat <<'EOF' | while read -r path; do
          ${DOC_REPORT_PATH}
          ${DOC_COMMITS_PATH}
          ${DOC_GLOBS_FILE}
          doc-sync-inputs/codex_prompt.md
          __codex_shared
          EOF
            if [ -n "$path" ] && ! grep -qx "$path" .git/info/exclude 2>/dev/null; then
              echo "$path" >> .git/info/exclude
            fi
          done

      - name: Run Codex doc sync edits
        id: edit
        uses: ./__codex_shared/actions/doc-sync/edit
        with:
          codex_auth_json_b64: ${{ secrets.CODEX_AUTH_JSON_B64 }}
          prompt_path: doc-sync-inputs/codex_prompt.md
          doc_report_path: ${{ env.DOC_REPORT_PATH }}
          doc_globs_file: doc-sync-inputs/${{ env.DOC_GLOBS_FILE }}
          doc_patch_file: ${{ env.DOC_PATCH_FILE }}
          doc_files_file: doc-changes.txt
          base_ref: ${{ needs.prepare_inputs.outputs.base_ref }}
          head_ref: ${{ needs.prepare_inputs.outputs.head_ref }}
          head_sha: ${{ needs.prepare_inputs.outputs.head_sha }}
          pr_number: ${{ needs.prepare_inputs.outputs.pr_number }}
          repository: ${{ needs.prepare_inputs.outputs.repository }}
          safety_strategy: ${{ inputs.safety_strategy }}
          model: ${{ inputs.model }}
          effort: ${{ inputs.effort }}
          codex_args: ${{ inputs.codex_args }}

      - name: Upload documentation report
        if: steps.edit.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DOC_REPORT_ARTIFACT }}
          retention-days: 7
          path: ${{ env.DOC_REPORT_PATH }}

      - name: Upload doc diff
        if: steps.edit.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DOC_PATCH_ARTIFACT }}
          retention-days: 7
          path: ${{ env.DOC_PATCH_FILE }}

      - name: Upload file list
        if: steps.edit.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.DOC_FILES_ARTIFACT }}
          retention-days: 7
          path: doc-changes.txt

  push_docs:
    needs: edit_docs
    if: needs.edit_docs.outputs.changed == 'true'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      HEAD_REF: ${{ needs.edit_docs.outputs.head_ref }}
      PR_NUMBER: ${{ needs.edit_docs.outputs.pr_number }}
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ needs.edit_docs.outputs.head_ref }}

      - name: Download doc diff
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.edit_docs.outputs.doc_patch_artifact }}
          path: doc-sync-artifacts

      - name: Download report
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.edit_docs.outputs.doc_report_artifact }}
          path: doc-sync-artifacts

      - name: Download file list
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.edit_docs.outputs.doc_files_artifact }}
          path: doc-sync-artifacts

      - name: Apply and push documentation updates
        id: push_action
        uses: ./__codex_shared/actions/doc-sync/push
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          doc_patch_file: doc-sync-artifacts/${{ env.DOC_PATCH_FILE }}
          doc_report_path: doc-sync-artifacts/${{ env.DOC_REPORT_PATH }}
          doc_files_path: doc-sync-artifacts/doc-changes.txt
          head_ref: ${{ env.HEAD_REF }}
          pr_number: ${{ needs.edit_docs.outputs.pr_number }}
