name: Codex Doc Sync

on:
  workflow_call:
    inputs:
      doc_globs:
        description: |-
          Newline-separated glob patterns that define documentation files (e.g., docs/**, **/*.md, README*).
        required: false
        type: string
        default: |
          docs/**
          **/*.md
          README*
      safety_strategy:
        description: Safety strategy passed to Codex (drop-sudo/read-only/unprivileged-user/unsafe).
        required: false
        type: string
        default: drop-sudo
      model:
        description: Optional Codex model override.
        required: false
        type: string
        default: ""
      effort:
        description: Optional Codex reasoning effort override.
        required: false
        type: string
        default: ""
      codex_args:
        description: Additional arguments passed to codex exec (JSON array or shell string).
        required: false
        type: string
        default: ""
    secrets:
      CODEX_AUTH_JSON_B64:
        description: Base64 encoded auth.json for Codex CLI.
        required: true

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: codex-doc-sync-${{ github.event.pull_request.number || github.event.issue.number || github.run_id }}
  cancel-in-progress: true

jobs:
  docs:
    if: github.event.pull_request != null || github.event.issue.pull_request != null
    runs-on: ubuntu-latest
    env:
      DOC_REPORT_PATH: doc-sync-report.md
    steps:
      - name: Resolve pull request context
        id: pr_context
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const repoFull = `${owner}/${repo}`;

            let pr = context.payload.pull_request;
            if (!pr && context.payload.issue?.pull_request) {
              const response = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: context.payload.issue.number,
              });
              pr = response.data;
            }

            if (!pr) {
              core.setOutput('proceed', 'false');
              core.info('No pull request context detected; skipping doc sync.');
              return;
            }

            const headRepoFull = pr.head.repo?.full_name || '';
            const sameRepo = headRepoFull === repoFull;
            if (!sameRepo) {
              core.info(`Skipping doc sync because head repository ${headRepoFull || '(unknown)'} differs from ${repoFull}.`);
            }

            core.setOutput('proceed', sameRepo ? 'true' : 'false');
            core.setOutput('number', String(pr.number));
            core.setOutput('base_ref', pr.base?.ref || '');
            core.setOutput('head_ref', pr.head?.ref || '');
            core.setOutput('head_sha', pr.head?.sha || '');
            core.setOutput('repository', repoFull);

      - name: Checkout target repository
        if: steps.pr_context.outputs.proceed == 'true'
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ steps.pr_context.outputs.head_sha }}

      - name: Ignore helper files
        if: steps.pr_context.outputs.proceed == 'true'
        run: |
          mkdir -p .git/info
          cat <<EOF | while read -r path; do
          ${DOC_REPORT_PATH}
          doc-commits.md
          doc-globs.txt
          codex_prompt.md
          __codex_shared
          EOF
            if [ -n "$path" ] && ! grep -qx "$path" .git/info/exclude 2>/dev/null; then
              echo "$path" >> .git/info/exclude
            fi
          done

      - name: Fetch base and collect commit summary
        if: steps.pr_context.outputs.proceed == 'true'
        run: |
          git fetch --no-tags origin ${{ steps.pr_context.outputs.base_ref }}
          git log --no-merges --pretty=format:'- %s (%h)' origin/${{ steps.pr_context.outputs.base_ref }}..${{ steps.pr_context.outputs.head_sha }} > doc-commits.md
          if [ ! -s doc-commits.md ]; then
            echo "- No commits detected between origin/${{ steps.pr_context.outputs.base_ref }} and ${{ steps.pr_context.outputs.head_sha }}." > doc-commits.md
          fi

      - name: Checkout shared workflow assets
        if: steps.pr_context.outputs.proceed == 'true'
        uses: actions/checkout@v5
        with:
          repository: activadee/codex-shared-workflows
          ref: main
          path: __codex_shared

      - name: Write documentation scope manifest
        if: steps.pr_context.outputs.proceed == 'true'
        env:
          DOC_GLOBS: ${{ inputs.doc_globs }}
          DOC_GLOBS_PATH: doc-globs.txt
        run: node __codex_shared/.github/scripts/doc-sync/write_doc_globs.js

      - name: Prepare Codex prompt
        if: steps.pr_context.outputs.proceed == 'true'
        env:
          BASE_REF: ${{ steps.pr_context.outputs.base_ref }}
          HEAD_REF: ${{ steps.pr_context.outputs.head_ref }}
          PR_NUMBER: ${{ steps.pr_context.outputs.number }}
          REPOSITORY: ${{ steps.pr_context.outputs.repository }}
          REPORT_PATH: ${{ env.DOC_REPORT_PATH }}
          TEMPLATE_PATH: __codex_shared/.github/prompts/codex-doc-sync.md
          DOC_GLOBS_PATH: doc-globs.txt
          PROMPT_PATH: codex_prompt.md
          COMMITS_PATH: doc-commits.md
        run: node __codex_shared/.github/scripts/doc-sync/prepare_prompt.js

      - name: Run Codex doc sync
        if: steps.pr_context.outputs.proceed == 'true'
        id: run_codex
        uses: activadee/codex-action@main
        env:
          DOC_REPORT_PATH: ${{ env.DOC_REPORT_PATH }}
          DOC_BASE_REF: ${{ steps.pr_context.outputs.base_ref }}
          DOC_HEAD_REF: ${{ steps.pr_context.outputs.head_ref }}
          DOC_HEAD_SHA: ${{ steps.pr_context.outputs.head_sha }}
          DOC_PR_NUMBER: ${{ steps.pr_context.outputs.number }}
          DOC_REPOSITORY: ${{ steps.pr_context.outputs.repository }}
          DOC_GLOBS: ${{ inputs.doc_globs }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ steps.pr_context.outputs.repository }}
        with:
          sandbox: danger-full-access
          codex-auth-json-b64: ${{ secrets.CODEX_AUTH_JSON_B64 }}
          prompt-file: codex_prompt.md
          safety-strategy: ${{ inputs.safety_strategy }}
          model: ${{ inputs.model }}
          effort: ${{ inputs.effort }}
          codex-args: ${{ inputs.codex_args }}

      - name: Verify clean working tree
        if: steps.pr_context.outputs.proceed == 'true'
        run: |
          if ! git diff --quiet --ignore-submodules --; then
            git status -sb
            echo "Working tree still has changes; expected Codex to commit and push via gh CLI." >&2
            exit 1
          fi
          if [ ! -f "$DOC_REPORT_PATH" ]; then
            echo "Documentation report $DOC_REPORT_PATH was not generated." >&2
            exit 1
          fi

      - name: Confirm remote branch is up to date
        if: steps.pr_context.outputs.proceed == 'true'
        run: |
          git fetch --no-tags origin ${{ steps.pr_context.outputs.head_ref }}
          local_sha=$(git rev-parse HEAD)
          remote_sha=$(git rev-parse origin/${{ steps.pr_context.outputs.head_ref }})
          if [ "$local_sha" != "$remote_sha" ]; then
            echo "Remote branch is not aligned with local HEAD; Codex was expected to push via gh CLI." >&2
            exit 1
          fi

      - name: Show documentation report
        if: steps.pr_context.outputs.proceed == 'true'
        run: cat "$DOC_REPORT_PATH"

      - name: Skip doc sync
        if: steps.pr_context.outputs.proceed != 'true'
        run: echo "Doc sync skipped for this event."
