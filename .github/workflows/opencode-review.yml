name: OpenCode Review

on:
  workflow_call:
    inputs:
      model:
        description: Model to use for review
        required: false
        type: string
        default: minimax/MiniMax-M2.1
      fallback_model:
        description: Fallback model if primary fails
        required: false
        type: string
        default: opencode/big-pickle
      share:
        description: Share the OpenCode session
        required: false
        type: boolean
        default: false
    secrets:
      MINIMAX_API_KEY:
        description: MiniMax API key
        required: false

permissions:
  contents: read
  pull-requests: write
  id-token: write

concurrency:
  group: opencode-review-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  review:
    name: Review PR with OpenCode
    if: github.event.pull_request != null && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Get PR number
        id: pr-number
        run: |
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install dependencies
        run: |
          if ! command -v gh &> /dev/null; then
            curl -fsSL https://cli.github.com/packages.sh | sudo bash
          fi
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Install OpenCode
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Get PR details
        id: pr-details
        run: |
          gh api /repos/${{ github.repository }}/pulls/${{ steps.pr-number.outputs.number }} > pr_data.json
          echo "title=$(jq -r .title pr_data.json)" >> $GITHUB_OUTPUT
          echo "sha=$(jq -r .head.sha pr_data.json)" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare prompt
        id: prompt
        run: |
          cat prompts/review.md > prompt.txt
          echo "" >> prompt.txt
          echo "PR_NUMBER: ${{ steps.pr-number.outputs.number }}" >> prompt.txt
          echo "PR_TITLE: $(jq -r .title pr_data.json)" >> prompt.txt
          echo "PR_DESCRIPTION: $(jq -r .body pr_data.json)" >> prompt.txt
          echo "COMMIT_SHA: ${{ steps.pr-details.outputs.sha }}" >> prompt.txt
          echo "prompt=$(cat prompt.txt)" >> $GITHUB_OUTPUT

      - name: Check PR guidelines compliance
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
          OPENCODE_PERMISSION: '{ "bash": { "gh*": "allow", "gh pr review*": "deny", "*": "deny" } }'
        run: |
          opencode run -m ${{ inputs.model }} "${{ steps.prompt.outputs.prompt }}"
