name: Codex Review

on:
  workflow_call:
    inputs:
      safety_strategy:
        description: Safety strategy passed to codex-action (drop-sudo/read-only/unprivileged-user/unsafe).
        required: false
        type: string
        default: drop-sudo
      prompt_extra:
        description: Optional extra markdown appended to the default prompt.
        required: false
        type: string
        default: ""
      model:
        description: Optional Codex model override.
        required: false
        type: string
        default: ""
      effort:
        description: Optional Codex reasoning effort override.
        required: false
        type: string
        default: ""
      codex_args:
        description: Additional arguments passed to codex exec (JSON array or shell string).
        required: false
        type: string
        default: ""
    secrets:
      CODEX_AUTH_JSON_B64:
        description: Base64 encoded auth.json for Codex CLI (ChatGPT subscription auth).
        required: true

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: codex-review-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  review:
    name: Run Codex review
    if: github.event.pull_request != null && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Fetch base reference
        run: git fetch --no-tags origin ${{ github.event.pull_request.base.ref }}

      - name: Checkout shared workflow assets
        uses: actions/checkout@v5
        with:
          repository: activadee/codex-shared-workflows
          ref: main
          path: __codex_shared

      - name: Collect review inputs
        uses: ./__codex_shared/.github/actions/codex-collect
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare Codex prompt
        run: |
          cp __codex_shared/.github/prompts/codex-review.md codex_prompt.md
          if [ -n "${{ inputs.prompt_extra }}" ]; then
            printf '\n\n%s\n' "${{ inputs.prompt_extra }}" >> codex_prompt.md
          fi

      - name: Load Codex output schema
        run: |
          echo "CODEX_OUTPUT_SCHEMA=$(jq -c . __codex_shared/.github/prompts/codex-review-schema.json)" >> "$GITHUB_ENV"

      - name: Run Codex review
        id: run_codex
        uses: activadee/codex-action@main
        with:
          codex-auth-json-b64: ${{ secrets.CODEX_AUTH_JSON_B64 }}
          safety-strategy: ${{ inputs.safety_strategy }}
          prompt-file: codex_prompt.md
          output-file: codex-output.json
          output-schema: ${{ env.CODEX_OUTPUT_SCHEMA }}
          model: ${{ inputs.model }}
          effort: ${{ inputs.effort }}
          codex-args: ${{ inputs.codex_args }}

      - name: Normalize Codex review output
        run: node __codex_shared/.github/scripts/codex/normalize-review.cjs

      - name: Submit review
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const submitReview = require('${{ github.workspace }}/__codex_shared/.github/scripts/codex/submit-review.js');
            await submitReview({ github, context, core });
        env:
          REVIEW_FILE: review-comments.json

      - name: Upload review artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: codex-review-debug-${{ github.run_id }}
          if-no-files-found: ignore
          retention-days: 7
          path: |
            diff.txt
            files.json
            files.jsonl
            existing_issue_comments.json
            existing_issue_comments.jsonl
            existing_reviews.json
            existing_reviews.jsonl
            existing_review_comments.json
            existing_review_comments.jsonl
            existing_review_threads.json
            existing_review_threads.jsonl
            review_metadata.json
            codex_prompt.md
            codex-output.json
            review-comments.json
            skipped-comments.json
